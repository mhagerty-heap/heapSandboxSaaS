<!DOCTYPE html>
<html>
<head>
  <title>HeapJS5: Redacting URL Query Params From All Events</title>
  <script type="text/javascript">
    window.heapReadyCb=window.heapReadyCb||[],window.heap=window.heap||[],heap.load=function(e,t){window.heap.envId=e,window.heap.clientConfig=t=t||{},window.heap.clientConfig.shouldFetchServerConfig=!1;var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://sdk.us.heap-api.com/config/"+e+"/heap_config.js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r);var n=["init","startTracking","stopTracking","track","resetIdentity","identify","getSessionId","getUserId","getIdentity","addUserProperties","addEventProperties","removeEventProperty","clearEventProperties","addAccountProperties","addAdapter","addTransformer","onReady",],i=function(e){return function(){var t=Array.prototype.slice.call(arguments,0);window.heapReadyCb.push({name:e,fn:function(){heap[e]&&heap[e].apply(heap,t)}})}};for(let p=0;p<n.length;p++)heap[n[p]]=i(n[p])};
    heap.load("527942070");
  </script>
</head>
<body>
<h1>HeapJS5: Redacting URL Query Params From All Events</h1>

<p>A Heap Transformer can be utilized to change/redact information prior to sending the event to Heap.  This example:<br>
<br>1) Loads this page (ensure to have query params appended at the end of the URL. ex: test1=abc&test2=def)<br>

<!-- <hi><b>Open the browser console to see commented action (you can also view the commented HTML code to see how this works)</b></h1><br>
<img src="./images/heapjs5/asyncSourceConsole.png" width="300" alt="Console Messages"><br><br>

<hi><b>Open the Heap "Live data view" screen to review the resulting Heap "track" call associated with the pageview (which has been delayed by 5 seconds)</b></h1><br>
<img src="./images/heapjs5/asyncSourceLiveView.png" width="750" alt="Console Messages"><br> -->



<script>
const transformerName = 'redactUrlQueryFromAllEventsTransformer';
const transformerFn = (messages: Array<EventMessage>): Array<EventMessage> => {
  const redactUrlQuery = (message: EventMessage) => {
    try {
      // Event is a pageview event
      if (message.type === 'meta_pageview') {
        message.data.pageview_info.url.query = '****';
      }

      // Event is a session event
      if (message.type === 'meta_session') {
        message.data.initial_pageview_info.url.query = '****';
      }

      // Event is a user event
      if (message.type === 'meta_user') {
        message.data.initial_session_info.initial_pageview_info.url.query = '****';
      }

      return message;
    } catch (e) {
      return message;
    }
  }

  return messages.map(redactPageTitle);
}

// Using metadata pipeline since we are modifying user, session, and pageview messages
const pipeline = 'metadata';

heap.addTransformerFn(transformerName, transformerFn, 'metadata');
</script>


</body>
</html>
