<!DOCTYPE html>
<html>
<head>
  <title>HeapJS5: Adding Event Properties from an Asynchronous Source</title>
  <script type="text/javascript">
    window.heapReadyCb=window.heapReadyCb||[],window.heap=window.heap||[],heap.load=function(e,t){window.heap.envId=e,window.heap.clientConfig=t=t||{},window.heap.clientConfig.shouldFetchServerConfig=!1;var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://sdk.us.heap-api.com/config/"+e+"/heap_config.js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r);var n=["init","startTracking","stopTracking","track","resetIdentity","identify","getSessionId","getUserId","getIdentity","addUserProperties","addEventProperties","removeEventProperty","clearEventProperties","addAccountProperties","addAdapter","addTransformer","onReady",],i=function(e){return function(){var t=Array.prototype.slice.call(arguments,0);window.heapReadyCb.push({name:e,fn:function(){heap[e]&&heap[e].apply(heap,t)}})}};for(let p=0;p<n.length;p++)heap[n[p]]=i(n[p])};
    heap.load("527942070");
  </script>
</head>
<body>
<h1>HeapJS5: Adding Event Properties from an Asynchronous Source</h1>

<p>A Heap Adaptor can be utilized to wait for asynchronous data to load from a 3rd party location prior to sending the event to Heap. This example waits 5 seconds while 3rd-party properties (city/state) are retrieved from <a href="https://my.api.mockaroo.com/heapJS5EventPropsCityState.json?key=17612760">a mock API endpoint</a>.  To use this example:<br>
<br>1) Load this page (the returned data will appear below)<br>
<div id="returnValueDiv">
<p id="returnedCity" style="color:green"></p>
<p id="returnedState" style="color:green"></p>
</div>
<br>2) Open the Heap "Live data view" screen to review the resulting Heap "track" call associated with the pageview (which has been delayed by 5 seconds)<br>
<img src="./images/heapjs5/asyncSourceLiveView.png" width="750" alt="Console Messages"><br>

<!-- <img src="./images/heapjs5/asyncSourceConsoleNetwork.png" width="700" alt="Network Tab"><br> -->

<script>
const adapterName = 'asyncSourcePropertiesAdapter';

const addAdditionalPropertiesFromAsyncSource = async () => {
  let properties; // create properties variable
  const res = await fetch('https://my.api.mockaroo.com/heapJS5EventPropsCityState.json?key=17612760') //fetch data from mockaroo
  properties = await res.json(); // set json to properties variable
  console.log('3rd-party properties loaded into browser =');
  console.log(properties) // print out the properties, to be handed to Heap Event
  document.getElementById("returnedCity").innerHTML = "Customer City = " + properties.asyncEventPropertyCity;
  document.getElementById("returnedState").innerHTML = "Customer State = " + properties.asyncEventPropertyState;
  heap.addEventProperties(properties);  // call heap.addEventProperties
  console.log("heap.addEventProperties sent with properties")
  heap.markAdapterAsResolved(adapterName);  // mark adaptor as resolved
  console.log("Heap Adaptor marked resolved")
}

const adapter = { name: adapterName, fn: addAdditionalPropertiesFromAsyncSource }; // initialize adaptor object
const config = { isBlocking: true, blockDurationInMs: 5000 }; // set config for adaptor object

heap.addAdapter(adapter, config); // start the Heap adaptor
</script>


</body>
</html>
